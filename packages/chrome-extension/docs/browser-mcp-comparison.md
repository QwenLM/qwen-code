# Chrome 扩展 vs 社区 MCP 方案对比

本文档详细对比 Chrome 扩展方案与社区开源 MCP 方案（如 Puppeteer/Playwright MCP）在浏览器集成方面的差异。

## 架构对比

### Chrome 扩展方案（当前实现）

```
┌─────────────────────────────────────────────────────────────┐
│                   用户正在使用的浏览器                        │
│  ┌──────────────┐   ┌──────────────┐   ┌──────────────────┐ │
│  │Service Worker│   │Content Script│   │  Side Panel UI   │ │
│  │  (后台服务)  │   │ (页面注入)   │   │   (侧边栏)       │ │
│  └──────┬───────┘   └──────┬───────┘   └────────┬─────────┘ │
│         └──────────────────┼────────────────────┘           │
│                            │                                │
│                   HTTP (127.0.0.1:18765)                    │
└────────────────────────────┼────────────────────────────────┘
                             │
              ┌──────────────▼──────────────┐
              │    Native Host (host.js)    │
              │   HTTP API + SSE 事件流     │
              └──────────────┬──────────────┘
                             │
                      ACP 协议 (JSON-RPC)
                             │
              ┌──────────────▼──────────────┐
              │       Qwen CLI 进程         │
              └──────────────┬──────────────┘
                             │
              ┌──────────────▼──────────────┐
              │    Browser MCP Server       │
              │  (提供浏览器操作工具)       │
              └─────────────────────────────┘
```

**特点**: 操作的是**用户当前正在浏览的页面**

### 社区 MCP 方案（Puppeteer/Playwright MCP）

```
              ┌─────────────────────────────┐
              │       Qwen CLI 进程         │
              └──────────────┬──────────────┘
                             │
                      MCP 协议 (JSON-RPC)
                             │
              ┌──────────────▼──────────────┐
              │  Puppeteer/Playwright MCP   │
              │        Server               │
              └──────────────┬──────────────┘
                             │
                      自动化 API
                             │
              ┌──────────────▼──────────────┐
              │   新启动的独立浏览器实例     │  ← 不是用户正在用的浏览器
              └─────────────────────────────┘
```

**特点**: 启动一个**全新的、独立的浏览器进程**

## 核心差异对比

| 维度               | Chrome 扩展方案                  | 社区 MCP 方案             |
| ------------------ | -------------------------------- | ------------------------- |
| **控制哪个浏览器** | 用户当前使用的浏览器             | 新启动的独立实例          |
| **典型使用场景**   | "帮我分析**我正在看的**这个页面" | "帮我打开 xxx.com 做某事" |
| **登录状态**       | 共享用户的 cookies/session       | 需要重新登录              |
| **架构复杂度**     | 需要扩展 + Native Host           | 只需 MCP Server           |
| **用户感知**       | 无感，在当前浏览器操作           | 会弹出新浏览器窗口        |
| **部署难度**       | 需要安装扩展 + 配置 Native Host  | 只需配置 MCP Server       |
| **浏览器支持**     | 仅 Chrome/Chromium               | 支持多种浏览器            |
| **调试便利性**     | 需要多层调试                     | 相对简单                  |

## 组件职责说明

### Service Worker 的作用

Service Worker 是 Chrome 扩展的后台服务，主要职责：

1. **通信枢纽**: 桥接 UI、Content Script 和 Native Host
2. **消息路由**: 接收来自 Native Host 的请求，分发到对应的 Content Script
3. **状态管理**: 管理连接状态、会话信息
4. **浏览器 API 调用**: 调用 chrome.tabs、chrome.debugger 等 API

### Content Script 的作用

Content Script 是注入到网页中的脚本，主要职责：

1. **DOM 访问**: 读取页面内容、元素信息
2. **页面操作**: 点击元素、填充表单、执行 JavaScript
3. **事件监听**: 捕获控制台日志、网络请求
4. **数据提取**: 提取文本、链接、图片等结构化数据

### 为什么社区 MCP 方案不需要这些组件？

社区 MCP 方案（如 Puppeteer/Playwright）通过以下方式绕过了这些限制：

1. **完全控制浏览器**: 通过 Chrome DevTools Protocol (CDP) 直接控制浏览器
2. **独立进程**: 启动独立的浏览器实例，不受扩展沙箱限制
3. **原生 API**: 直接调用浏览器自动化 API，无需注入脚本

## 通信协议详解

### Chrome 扩展方案的通信层

```
┌─────────────────────────────────────────────────────────────────┐
│ 层级 1: Web Page ↔ Content Script                               │
│ 协议: window.postMessage / chrome.runtime.sendMessage           │
│ 消息类型: EXTRACT_DATA, FILL_INPUTS, CLICK_ELEMENT, etc.       │
├─────────────────────────────────────────────────────────────────┤
│ 层级 2: Content Script ↔ Service Worker                        │
│ 协议: chrome.runtime.sendMessage / chrome.tabs.sendMessage      │
├─────────────────────────────────────────────────────────────────┤
│ 层级 3: Service Worker ↔ Native Host                           │
│ 协议: HTTP REST API (端口 18765)                                │
│ 端点: POST /api, GET /events (SSE), GET /healthz               │
├─────────────────────────────────────────────────────────────────┤
│ 层级 4: Native Host ↔ Qwen CLI                                 │
│ 协议: ACP (Agent Communication Protocol) - JSON-RPC over stdio │
├─────────────────────────────────────────────────────────────────┤
│ 层级 5: Qwen CLI ↔ Browser MCP Server                          │
│ 协议: MCP (Model Context Protocol) - Content-Length framed     │
└─────────────────────────────────────────────────────────────────┘
```

### 社区 MCP 方案的通信层

```
┌─────────────────────────────────────────────────────────────────┐
│ 层级 1: Qwen CLI ↔ Puppeteer MCP Server                        │
│ 协议: MCP (Model Context Protocol) - JSON-RPC over stdio       │
├─────────────────────────────────────────────────────────────────┤
│ 层级 2: MCP Server ↔ Browser                                   │
│ 协议: Chrome DevTools Protocol (CDP) over WebSocket            │
└─────────────────────────────────────────────────────────────────┘
```

## 适用场景选择

### 选择 Chrome 扩展方案的场景

- 需要分析用户**当前正在浏览**的页面
- 需要利用用户已有的**登录状态**（如分析登录后的页面）
- 需要**无感知**地在后台获取浏览器信息
- 需要访问用户浏览器的**历史记录、书签**等数据
- 需要监控用户**实时浏览行为**

### 选择社区 MCP 方案的场景

- 自动化任务（爬虫、数据采集）
- 自动化测试
- 需要**并行操作多个浏览器实例**
- 不需要访问用户当前浏览器的状态
- 希望**简化部署**，不需要用户安装扩展
- 需要支持**非 Chrome 浏览器**

## 混合方案

在某些场景下，可以结合两种方案的优势：

1. **Chrome 扩展获取上下文**: 使用扩展获取用户当前页面的 URL、cookies
2. **Puppeteer MCP 执行操作**: 将上下文传递给 Puppeteer MCP，在独立浏览器中执行复杂自动化任务

```
用户浏览器 (Chrome 扩展)
    │
    │ 提取 URL、cookies、登录状态
    ▼
Qwen CLI
    │
    │ 使用提取的上下文
    ▼
Puppeteer MCP → 独立浏览器实例
```

## 总结

| 需求                   | 推荐方案    |
| ---------------------- | ----------- |
| "帮我分析这个页面"     | Chrome 扩展 |
| "帮我打开某网站做某事" | 社区 MCP    |
| "帮我用我的账号操作"   | Chrome 扩展 |
| "帮我批量处理多个页面" | 社区 MCP    |
| "帮我监控页面变化"     | Chrome 扩展 |
| "帮我自动化测试"       | 社区 MCP    |

**核心结论**: Service Worker 和 Content Script 的存在是为了**访问用户当前浏览器会话**，这是社区 Puppeteer/Playwright MCP 无法做到的。两种方案各有优劣，应根据具体需求选择。
