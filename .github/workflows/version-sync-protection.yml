name: Version Sync Protection

# Защита от случайного изменения описания при автообновлении версии

on:
  pull_request:
    paths:
      - 'package.json'
      - 'package-lock.json'
      - 'CHANGELOG.md'
      - '.github/workflows/release.yml'

jobs:
  protect-description:
    name: Protect README Description
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check README description hasn't changed
        run: |
          # Получить описание из основной ветки
          MAIN_DESC=$(git show origin/main:README.md | grep -A1 "^# Qwen Code" | grep -o '\*\*AI-powered.*\*\*' | head -1)
          
          # Получить описание из текущей PR
          PR_DESC=$(git show HEAD:README.md | grep -A1 "^# Qwen Code" | grep -o '\*\*AI-powered.*\*\*' | head -1)
          
          echo "Main branch description: $MAIN_DESC"
          echo "PR branch description: $PR_DESC"
          
          if [ "$MAIN_DESC" != "$PR_DESC" ]; then
            echo "❌ ERROR: README description was changed!"
            echo "Expected: $MAIN_DESC"
            echo "Got: $PR_DESC"
            exit 1
          else
            echo "✅ README description is protected and unchanged"
          fi

      - name: Verify package.json structure
        run: |
          # Проверить что package.json валиден
          node -e "const pkg = require('./package.json'); 
            console.log('✅ package.json is valid');
            console.log('   Name:', pkg.name);
            console.log('   Version:', pkg.version);"

      - name: Check for accidental description field changes
        run: |
          # Проверить чтобы не было добавлено поле "description" в package.json
          if grep -q '"description"' package.json; then
            echo "⚠️  WARNING: package.json contains 'description' field"
            echo "This may cause issues with automated versioning"
          else
            echo "✅ No description field in package.json (good!)"
          fi

  lint-version-change:
    name: Lint Version Changes
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check version format
        run: |
          VERSION=$(grep '"version"' package.json | grep -oE '[0-9]+\.[0-9]+\.[0-9]+')
          echo "Current version: $VERSION"
          
          # Проверить что версия соответствует semver
          if ! echo "$VERSION" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+([-+].*)?$'; then
            echo "❌ Version does not follow SemVer format: $VERSION"
            exit 1
          fi
          echo "✅ Version format is valid (SemVer)"

      - name: Check CHANGELOG consistency
        run: |
          VERSION=$(grep '"version"' package.json | grep -oE '[0-9]+\.[0-9]+\.[0-9]+')
          
          if grep -q "## \[$VERSION\]" CHANGELOG.md || grep -q "# $VERSION" CHANGELOG.md; then
            echo "✅ CHANGELOG contains entry for version $VERSION"
          else
            echo "⚠️  WARNING: CHANGELOG may not have entry for version $VERSION"
            echo "Please update CHANGELOG.md manually if this is a release"
          fi
