name: Sync with Upstream

on:
  schedule:
    # –ö–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 00:00 UTC (05:00 –ø–æ –ß–µ–ª—è–±–∏–Ω—Å–∫—É)
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      
      # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤–∞—à–∏ —Ñ–∞–π–ª—ã –ø–µ—Ä–µ–¥ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–µ–π
      - name: Backup custom files
        run: |
          mkdir -p .backup
          cp -r README.md .backup/ 2>/dev/null || true
          cp -r docs/assets .backup/ 2>/dev/null || true
          ls -la .backup/
      
      # –î–æ–±–∞–≤–ª—è–µ–º upstream —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
      - name: Add upstream remote
        run: |
          git remote add upstream https://github.com/QwenLM/qwen-code.git
          git fetch upstream main
      
      # –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è
      - name: Check for differences
        id: check_diff
        run: |
          # –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ –≤–µ—Ç–∫–∏
          DIFF_COUNT=$(git diff --name-only main upstream/main | wc -l)
          if [ "$DIFF_COUNT" -gt 0 ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "–ù–∞–π–¥–µ–Ω–æ $DIFF_COUNT –∏–∑–º–µ–Ω–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤"
            git diff --name-only main upstream/main
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "–ù–µ—Ç –Ω–æ–≤—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –æ—Ç upstream"
          fi
      
      # –ï—Å–ª–∏ –µ—Å—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è - —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º
      - name: Merge upstream with strategy
        if: steps.check_diff.outputs.has_changes == 'true'
        run: |
          # –°–æ–∑–¥–∞—ë–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –≤–µ—Ç–∫—É –¥–ª—è —Å–ª–∏—è–Ω–∏—è
          git checkout -b sync-upstream
          
          # –ë–µ—Ä—ë–º –≤—Å–µ —Ñ–∞–π–ª—ã –∏–∑ upstream
          git merge -X theirs upstream/main --allow-unrelated-histories --no-commit
          
          echo "–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∞, –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤–∞—à–∏ —Ñ–∞–π–ª—ã..."
      
      # –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤–∞—à–∏ —Ñ–∞–π–ª—ã
      - name: Restore custom files
        if: steps.check_diff.outputs.has_changes == 'true'
        run: |
          # –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º README.md
          if [ -f ".backup/README.md" ]; then
            cp .backup/README.md README.md
            echo "‚úì README.md –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
          fi
          
          # –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º docs/assets
          if [ -d ".backup/assets" ]; then
            mkdir -p docs
            cp -r .backup/assets docs/
            echo "‚úì docs/assets –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
          fi
          
          # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —á—Ç–æ –ø–æ–º–µ–Ω—è–ª–æ—Å—å
          echo "\n–°—Ç–∞—Ç—É—Å –∏–∑–º–µ–Ω–µ–Ω–∏–π:"
          git status
      
      # –ö–æ–º–º–∏—Ç–∏–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
      - name: Commit changes
        if: steps.check_diff.outputs.has_changes == 'true'
        run: |
          git add -A
          git commit -m "chore: sync with upstream QwenLM/qwen-code
          
–û—Å–Ω–æ–≤–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:
- –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–º
- –°–æ—Ö—Ä–∞–Ω–µ–Ω—ã –ª–æ–∫–∞–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã: README.md, docs/assets/
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ GitHub Actions

Upstream: https://github.com/QwenLM/qwen-code" || echo "–ù–µ—á–µ–≥–æ –∫–æ–º–º–∏—Ç–∏—Ç—å"
      
      # –°–æ–∑–¥–∞—ë–º pull request
      - name: Create Pull Request
        if: steps.check_diff.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: sync with upstream QwenLM/qwen-code"
          title: "üîÑ chore: —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å upstream"
          body: |
            ## –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å –æ—Å–Ω–æ–≤–Ω—ã–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–º
            
            –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ [QwenLM/qwen-code](https://github.com/QwenLM/qwen-code)
            
            ### –ß—Ç–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ:
            - ‚úÖ `README.md` (–≤–∞—à–∞ –ª–æ–∫–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è)
            - ‚úÖ `docs/assets/` (–≤—Å–µ –≤–∞—à–∏ –ª–æ–∫–∞–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã)
            
            ### –ß—Ç–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ:
            - üîÑ –í—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã –∏–∑ upstream
            - üîÑ –í–µ—Ä—Å–∏—è –ø–∞–∫–µ—Ç–∞ (–µ—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å)
            
            ### –î–∞–ª—å–Ω–µ–π—à–∏–µ –¥–µ–π—Å—Ç–≤–∏—è:
            1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
            2. –†–∞–∑—Ä–µ—à–∏—Ç–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
            3. –°–ª–µ–π—Ç–µ PR –≤ main
            
            **–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          branch: sync-upstream
          delete-branch: true
          labels: |
            chore
            upstream-sync
            automated
      
      # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
      - name: Log sync result
        if: always()
        run: |
          echo "=== –†–µ–∑—É–ª—å—Ç–∞—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ ==="
          echo "–î–∞—Ç–∞: $(date)"
          echo "–ù–∞–π–¥–µ–Ω–æ –∏–∑–º–µ–Ω–µ–Ω–∏–π: ${{ steps.check_diff.outputs.has_changes }}"
          echo "============================="
